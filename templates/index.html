
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Card Reader Dashboard</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #dbeafe, #eff6ff);
      min-height: 100vh;
      padding-top: 14px;
    }

    .login-container {
      max-width: 400px;
      margin: auto;
      background: white;
      padding: 35px;
      border-radius: 15px;
      box-shadow: 0 15px 30px rgba(0,0,0,0.1);
      text-align: center;
    }
    .login-logo {
      max-width: 120px;
      margin-bottom: 20px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    .login-container h2 {
      margin-bottom: 25px;
      font-size: 24px;
      color: #333;
    }

    .login-container input {
      margin-bottom: 15px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding: 10px 20px;
      background-color: white;
      box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    }

    .dashboard-header h2 {
      margin: 0 auto;
      color: #0369a1;
      font-weight: bold;
    }

    .nav-button, .logout-button {
      padding: 8px 14px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .nav-button {
      background-color: #e0f2fe;
      color: #0369a1;
    }

    .nav-button:hover {
      background-color: #bae6fd;
    }

    .logout-button {
      background-color: #f87171;
      color: white;
    }

    .logout-button:hover {
      background-color: #ef4444;
    }

    .reader-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      padding: 0 20px;
    }

    .reader-box {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.05);
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .reader-title {
      font-weight: 600;
      font-size: 18px;
      text-align: center;
      background: #0369a1;
      color: white;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .reader-table {
      width: 100%;
      font-size: 14px;
    }

    .reader-table td:first-child {
      font-weight: 500;
      color: #374151;
      width: 40%;
      padding-bottom: 10px;
    }
    .reader-table td {
      max-width: 0;
      overflow: hidden;
    }
    .scrollable-cell {
      font-size: 14px !important;
    }

    .scrollable-cell,
    .atr-value {
      display: block;
      max-width: 100%;
      overflow: auto;
      white-space: nowrap;
      font-size: 13px;
      padding: 4px;
      box-sizing: border-box;
    }
    .card-status {
      font-weight: 500;
      padding: 2px 6px;
      border-radius: 4px;
      display: inline-block;
      color: white;
      font-size: 13px;
    }

    .card-status-inserted {
      background-color: #10b981; /* green */
    }

    .card-status-removed {
      background-color: #ef4444; /* red */
    }

    .status-button {
      margin-top: auto;
      text-align: center;
      padding: 10px;
      font-weight: 600;
      border-radius: 6px;
      color: white;
      margin-top: 20px;
    }

    .status-disconnected {
      background-color: #9ca3af;
    }

    .status-card-connected {
      background-color: #10b981;
    }

    .status-card-removed {
      background-color: #f59e0b;
    }

    .history-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
    }

    .viewhistoy-button,
    .dowenload-button {
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      background-color: #e0f2fe;
      color: #0369a1;
    }

    .viewhistoy-button:hover {
      background-color: #bae6fd;
    }

    .dowenload-button:hover {
      background-color: #bbf7d0;
      color: #065f46;
    }

    /* Modal CSS adjustments */
    .modal-content {
      max-height: 80vh;
      overflow: hidden;
    }

    .modal-body {
      max-height: 60vh;
      overflow-y: auto;
      padding: 15px;
    }

    .modal-body .table {
      margin-bottom: 0;
      font-size: 14px;
    }

    .modal-body .table th,
    .modal-body .table td {
      padding: 8px;
      vertical-align: middle;
    }

    .modal-body .table-striped tbody tr:nth-of-type(odd) {
      background-color: #f8fafc;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="login-container" id="loginContainer">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="login-logo mb-3">
      <h2>Login</h2>
      <input type="text" id="username" class="form-control" placeholder="Username">
      <input type="password" id="password" class="form-control" placeholder="Password">
      <button class="btn btn-primary mt-3 w-100" onclick="login()">Login</button>
    </div>
  </div>

  <div class="container-fluid" id="dashboard" style="display: none;">
    <div class="dashboard-header">
      <div>
        <button class="nav-button" onclick="window.location.href='/'">Home</button>
        <button class="nav-button" onclick="window.location.href='/graphs.html'">Graphs</button>
        <button class="nav-button" onclick="window.location.href='/logs.html'">Logs</button>
      </div>
      <h2>Smart Card Reader Dashboard</h2>
      <div>
        <button class="logout-button" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="reader-grid" id="readerGrid"></div>

  
    <div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">History for Reader <span id="readerIndexLabel"></span></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <ul class="nav nav-tabs" id="historyTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="reader-tab" data-bs-toggle="tab" data-bs-target="#reader" type="button" role="tab">Reader History</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="auth-tab" data-bs-toggle="tab" data-bs-target="#auth" type="button" role="tab">Auth History</button>
              </li>
            </ul>
            <div class="tab-content mt-3" id="historyTabContent">
              <div class="tab-pane fade show active" id="reader" role="tabpanel">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Timestamp</th>
                      <th>Status</th>
                      <th>Company Name</th>
                      <th>ATR</th>
                      <th>Authentication</th>
                      <th>Present Time</th>
                    </tr>
                  </thead>
                  <tbody id="readerHistoryContent"></tbody>
                </table>
              </div>
              <div class="tab-pane fade" id="auth" role="tabpanel">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Timestamp</th>
                      <th>Authentication</th>
                    </tr>
                  </thead>
                  <tbody id="authHistoryContent"></tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="copyATRModal" tabindex="-1" aria-labelledby="copyATRModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="copyATRModalLabel">ATR Copied</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            ATR copied from Reader <span id="copyReaderIndexLabel"></span> to clipboard.
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Initialize SocketIO for logs
    const socket = io('/logs');
    socket.on('connect', () => {
      console.log('Connected to /logs namespace');
    });
    socket.on('log_message', (msg) => {
      const logDiv = $('#logMessages');
      logDiv.append(`<p>${msg.data}</p>`);
      logDiv[0].scrollTop = logDiv[0].scrollHeight;
    });

    function updateReaders() {
      $.get('/readers', function (response) {
        const grid = $('#readerGrid');
        grid.empty();
        if (response && response.status === 'success' && Array.isArray(response.data)) {
          response.data.forEach(reader => {
            const statusClass =
              reader.status === 'Card-Connected'
                ? 'status-card-connected'
                : reader.status === 'Disconnected'
                ? 'status-disconnected'
                : 'status-card-removed';

            grid.append(`
              <div class="reader-box">
                <div class="reader-title">Reader ${reader.readerIndex + 1}</div>
                <table class="reader-table">
                  <tr><td>Company</td><td><div class="scrollable-cell">${reader.companyName}</div></td></tr>
                  <tr><td>ATR</td><td><div class="atr-value" ondblclick="copyATR('${reader.atr}', ${reader.readerIndex})">${reader.atr}</div></td></tr>
                  <tr><td>Auth</td><td>${reader.authentication}</td></tr>
                  <tr><td>Card Status</td><td><span class="card-status ${reader.presentTime && reader.presentTime !== 'N/A' ? 'card-status-inserted' : 'card-status-removed'}">
                    ${reader.presentTime && reader.presentTime !== 'N/A' ? 'Card Inserted' : 'Card Removed'}
                  </span></td></tr>
                  <tr><td>Card Time</td><td>${reader.presentTime}</td></tr>
                </table>
                <div class="history-actions">
                  <button class="viewhistoy-button" onclick="viewhistoy(${reader.readerIndex})">View History</button>
                  <button class="dowenload-button" onclick="dowenload_History()">Download History</button>
                </div>
                <div class="status-button ${statusClass}">${reader.status}</div>
              </div>
            `);
          });
        } else {
          grid.append('<p class="text-danger">Unable to load reader data. Check server logs.</p>');
        }
      }).fail(() => {
        $('#readerGrid').html('<p class="text-danger">Error: Server is unreachable. Check console for details.</p>');
      });
    }

    function login() {
  const username = $('#username').val();  // gets value from input field
  const password = $('#password').val();

  $.ajax({
    url: '/login',
    type: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({ username, password }),
    success: function (response) {
      if (response.status === 'success') {
        localStorage.setItem('loggedIn', 'true');
        $('#loginContainer').hide();
        $('#dashboard').show();
        updateReaders();
        setInterval(updateReaders, 1000);
      } else {
        alert('Login failed: ' + response.message);
      }
    },
    error: function (xhr) {
      const message = xhr.responseJSON?.message || 'Server error';
      alert('Login failed: ' + message);
    }
  });
}

    function logout() {
      $.post('/logout', function (response) {
        if (response.status === 'success') {
          localStorage.removeItem('loggedIn');
          $('#dashboard').hide();
          $('#loginContainer').show();
          clearInterval(updateReaders);
        } else {
          alert('Logout failed: ' + response.message);
        }
      }).fail(function () {
        alert('Logout failed: Server error');
      });
    }

    function viewhistoy(readerIndex) {
      $.get(`/history?readerIndex=${readerIndex}`, function (response) {
        if (response && response.status === 'success' && Array.isArray(response.data)) {
          const readerHistoryContent = $('#readerHistoryContent');
          const authHistoryContent = $('#authHistoryContent');
          readerHistoryContent.empty();
          authHistoryContent.empty();

          $('#readerIndexLabel').text(readerIndex + 1);

          response.data.forEach(entry => {
            const row = `
              <tr>
                <td>${entry.timestamp}</td>
                <td>${entry.status}</td>
                <td>${entry.companyName}</td>
                <td>${entry.atr}</td>
                <td>${entry.authentication}</td>
                <td>${entry.presentTime}</td>
              </tr>`;
            readerHistoryContent.append(row);

            if (entry.authentication !== 'Unknown') {
              const authRow = `
                <tr>
                  <td>${entry.timestamp}</td>
                  <td>${entry.authentication}</td>
                </tr>`;
              authHistoryContent.append(authRow);
            }
          });

          $('#historyModal').modal('show');
        } else {
          alert('Failed to load history: ' + (response.message || 'Invalid response'));
        }
      }).fail(function () {
        alert('Error: Unable to fetch history from server');
      });
    }

    function dowenload_History() {
      window.location.href = '/download_history';
    }

    function copyATR(atr, readerIndex) {
      navigator.clipboard.writeText(atr).then(() => {
        $('#copyReaderIndexLabel').text(readerIndex + 1);
        $('#copyATRModal').modal('show');
      }).catch(err => {
        alert('Failed to copy ATR: ' + err);
      });
    }

    $(document).ready(function () {
      const isLoggedIn = localStorage.getItem('loggedIn') === 'true';
      if (isLoggedIn) {
        $.post('/login', { username: 'techvezoto', password: 'techvezoto@1122' }, function (response) {
          if (response.status === 'success') {
            $('#loginContainer').hide();
            $('#dashboard').show();
            updateReaders();
            setInterval(updateReaders, 1000);
          } else {
            localStorage.removeItem('loggedIn');
            $('#loginContainer').show();
            $('#dashboard').hide();
          }
        }).fail(function () {
          localStorage.removeItem('loggedIn');
          $('#loginContainer').show();
          $('#dashboard').hide();
        });
      } else {
        $('#loginContainer').show();
        $('#dashboard').hide();
      }
    });
  </script>
</body>
</html>
