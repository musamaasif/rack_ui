<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Smart Card Reader Dashboard - Home Rack</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #dbeafe, #eff6ff);
      min-height: 100vh;
      padding-top: 14px;
    }

    .login-container {
      max-width: 400px;
      margin: auto;
      background: white;
      padding: 35px;
      border-radius: 15px;
      box-shadow: 0 15px 30px rgba(0,0,0,0.1);
      text-align: center;
    }
    .login-logo {
      max-width: 120px;
      margin-bottom: 20px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }

    .login-container h2 {
      margin-bottom: 25px;
      font-size: 24px;
      color: #333;
    }

    .login-container input {
      margin-bottom: 15px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding: 10px 20px;
      background-color: white;
      box-shadow: 0 5px 20px rgba(0,0,0,0.05);
    }

    .dashboard-header h2 {
      margin: 0 auto;
      color: #0369a1;
      font-weight: bold;
    }

    .nav-button, .logout-button {
      padding: 8px 14px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .nav-button {
      background-color: #e0f2fe;
      color: #0369a1;
    }

    .nav-button:hover {
      background-color: #bae6fd;
    }

    .logout-button {
      background-color: #f87171;
      color: white;
    }

    .logout-button:hover {
      background-color: #ef4444;
    }

    .reader-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      padding: 0 20px;
    }

    .reader-box {
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.05);
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .reader-title {
      font-weight: 600;
      font-size: 18px;
      text-align: center;
      background: #0369a1;
      color: white;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .reader-table {
      width: 100%;
      font-size: 14px;
    }

    .reader-table td:first-child {
      font-weight: 500;
      color: #374151;
      width: 40%;
      padding-bottom: 10px;
    }
    .reader-table td {
      max-width: 0;
      overflow: hidden;
    }
    .scrollable-cell {
      font-size: 14px !important;
    }

    .scrollable-cell,
    .atr-value {
      display: block;
      max-width: 100%;
      overflow: auto;
      white-space: nowrap;
      font-size: 13px;
      padding: 4px;
      box-sizing: border-box;
      cursor: pointer; 
    }
    .atr-value:hover {
        background-color: #f0f9ff; 
    }

    .card-status {
      font-weight: 500;
      padding: 2px 6px;
      border-radius: 4px;
      display: inline-block;
      color: white;
      font-size: 13px;
    }

    .card-status-inserted {
      background-color: #10b981; /* green */
    }

    .card-status-removed {
      background-color: #ef4444; /* red */
    }

    .status-button {
      margin-top: auto;
      text-align: center;
      padding: 10px;
      font-weight: 600;
      border-radius: 6px;
      color: white;
      margin-top: 20px;
    }

    .status-disconnected {
      background-color: #9ca3af;
    }

    .status-card-connected {
      background-color: #10b981;
    }

    .status-card-removed {
      background-color: #f59e0b;
    }

    .history-actions {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
    }

    .viewhistoy-button,
    .dowenload-button {
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      border: none;
      background-color: #e0f2fe;
      color: #0369a1;
    }

    .viewhistoy-button:hover {
      background-color: #bae6fd;
    }

    .dowenload-button:hover {
      background-color: #bbf7d0;
      color: #065f46;
    }

    /* --- NEW: Notification Style --- */
    .copy-feedback {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #333;
        color: #fff;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        z-index: 9999;
        box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        display: none; /* Hidden by default */
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="login-container" id="loginContainer">
      <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="login-logo mb-3">
      <h2>Login</h2>
      <form id="loginForm">
        <input type="text" id="username" class="form-control" placeholder="Username" required>
        <input type="password" id="password" class="form-control" placeholder="Password" required>
        <button id="loginBtn" type="submit" class="btn btn-primary mt-3 w-100">Login</button>
      </form>
    </div>
  </div>

  <div class="container-fluid" id="dashboard" style="display: none;">
    <div class="dashboard-header">
      <div>
        <button class="nav-button" onclick="window.location.href='/'">Home</button>
        <button class="nav-button" onclick="window.location.href='/graphs.html'">Graphs</button>
        <button class="nav-button" onclick="window.location.href='/logs.html'">Logs</button>
      </div>
      <h2>Smart Card Reader Dashboard - Home Rack</h2>
      <div>
        <button class="logout-button" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="reader-grid" id="readerGrid"></div>
  </div>

  <script>
    // Socket.IO logs
    const socket = io('/logs');
    socket.on('connect', () => console.log('Connected to /logs namespace'));
    socket.on('log_message', (msg) => {
      const logDiv = $('#logMessages');
      if (logDiv.length) {
        logDiv.append(`<p>${msg.data}</p>`);
        logDiv[0].scrollTop = logDiv[0].scrollHeight;
      }
    });

    let readersTimer = null;
    function startReadersPolling() {
      if (!readersTimer) {
        readersTimer = setInterval(updateReaders, 1000);
      }
    }
    function stopReadersPolling() {
      if (readersTimer) {
        clearInterval(readersTimer);
        readersTimer = null;
      }
    }

    function updateReaders() {
      $.get('/readers', function (response) {
        const grid = $('#readerGrid');
        grid.empty();
        if (response && response.status === 'success' && Array.isArray(response.data)) {
          response.data.forEach(reader => {
            const statusClass =
              reader.status === 'Card-Connected'
                ? 'status-card-connected'
                : reader.status === 'Disconnected'
                ? 'status-disconnected'
                : 'status-card-removed';
            grid.append(`
              <div class="reader-box">
                <div class="reader-title">Reader ${reader.readerIndex + 1}</div>
                <table class="reader-table">
                  <tr><td>Company</td><td><div class="scrollable-cell">${reader.companyName}</div></td></tr>
                  <tr><td>ATR</td><td><div class="atr-value" title="Double click to copy">${reader.atr}</div></td></tr>
                  <tr><td>Auth</td><td>${reader.authentication}</td></tr>
                  <tr><td>Card Status</td><td><span class="card-status ${reader.presentTime && reader.presentTime !== 'N/A' ? 'card-status-inserted' : 'card-status-removed'}">
                    ${reader.presentTime && reader.presentTime !== 'N/A' ? 'Card Inserted' : 'Card Removed'}
                  </span></td></tr>
                  <tr><td>Card Time</td><td>${reader.presentTime}</td></tr>
                </table>
                <div class="history-actions">
                  <button class="viewhistoy-button" onclick="viewhistoy(${reader.readerIndex})">View History</button>
                  <button class="dowenload-button" onclick="dowenload_History()">Download History</button>
                </div>
                <div class="status-button ${statusClass}">${reader.status}</div>
              </div>
            `);
          });
        } else {
          grid.append('<p class="text-danger">Unable to load reader data. Check server logs.</p>');
        }
      }).fail(() => {
        $('#readerGrid').html('<p class="text-danger">Error: Server is unreachable. Check console for details.</p>');
      });
    }

    // Login Logic
    let loggingIn = false;
    function setLoginDisabled(disabled) {
      $('#loginBtn').prop('disabled', disabled);
      $('#username').prop('disabled', disabled);
      $('#password').prop('disabled', disabled);
    }

    async function doLogin() {
      if (loggingIn) return;
      loggingIn = true;
      setLoginDisabled(true);

      const username = $('#username').val().trim();
      const password = $('#password').val();

      try {
        const res = await fetch('/login', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();
        if (res.ok && data.status === 'success') {
          localStorage.setItem('loggedIn', 'true');
          $('#loginContainer').hide();
          $('#dashboard').show();
          updateReaders();
          startReadersPolling();
        } else {
          alert(data.message || 'Login failed');
          setLoginDisabled(false);
          loggingIn = false;
        }
      } catch (e) {
        alert('Network error while logging in');
        setLoginDisabled(false);
        loggingIn = false;
      }
    }

    $('#loginForm').on('submit', function (e) {
      e.preventDefault();
      doLogin();
    });

    $('#username, #password').on('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        doLogin();
      }
    });

    function logout() {
      $.post('/logout', function (response) {
        if (response.status === 'success') {
          localStorage.removeItem('loggedIn');
          stopReadersPolling();
          $('#dashboard').hide();
          $('#loginContainer').show();
          setLoginDisabled(false);
          loggingIn = false;
        } else {
          alert('Logout failed: ' + response.message);
        }
      }).fail(() => alert('Logout failed: Server error'));
    }

    $(document).ready(async function () {
      const isLoggedIn = localStorage.getItem('loggedIn') === 'true';
      if (isLoggedIn) {
        try {
          const res = await fetch('/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: 'techvezoto', password: 'techvezoto@1122' })
          });
          const data = await res.json();
          if (res.ok && data.status === 'success') {
            $('#loginContainer').hide();
            $('#dashboard').show();
            updateReaders();
            startReadersPolling();
          } else {
            localStorage.removeItem('loggedIn');
            $('#loginContainer').show();
            $('#dashboard').hide();
          }
        } catch {
          localStorage.removeItem('loggedIn');
          $('#loginContainer').show();
          $('#dashboard').hide();
        }
      } else {
        $('#loginContainer').show();
        $('#dashboard').hide();
      }
    });

    // Placeholders
    function viewhistoy(readerIndex) {
      console.log('View history for reader', readerIndex);
    }
    function dowenload_History() {
      window.location.href = '/download_history';
    }

    // --- UPDATED COPY LOGIC WITH POPUP NOTIFICATION ---
    document.addEventListener('dblclick', function(event) {
        const target = event.target;
        
        // 1. Get text content
        const text = target.innerText || target.textContent;
        
        // 2. Clean it
        const cleanText = text.replace(/[\s\u00A0]/g, '');

        // 3. Check if it looks like an ATR
        const isATR = /^[0-9A-Fa-f]{10,}$/.test(cleanText);

        if (isATR) {
            // 4. Copy to clipboard
            navigator.clipboard.writeText(cleanText).then(function() {
                
                // 5. Visual Feedback: Flash Green
                const originalColor = target.style.color;
                const originalWeight = target.style.fontWeight;
                
                target.style.color = '#10b981'; // Green
                target.style.fontWeight = 'bold';
                target.style.transition = 'color 0.2s ease';
                
                // Restore color after 500ms
                setTimeout(() => {
                    target.style.color = originalColor;
                    target.style.fontWeight = originalWeight;
                }, 500);

                // 6. POPUP NOTIFICATION
                // Create a temporary div if it doesn't exist, or make a new one
                let notification = $('<div class="copy-feedback">ATR Copied!</div>');
                $('body').append(notification);
                
                // Fade in, wait, Fade out, Remove
                notification.fadeIn(200).delay(1000).fadeOut(200, function() {
                    $(this).remove();
                });
                
            }).catch(function(err) {
                console.error('Failed to copy: ', err);
            });
        }
    });
  </script>
</body>
</html>
